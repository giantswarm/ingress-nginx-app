# Default values for nginx-ingress-controller-app.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

# baseDomain is a dynamic value, it comes from the cluster values configmap
# applies only to Giant Swarm clusters
baseDomain: uun5a.k8s.ginger.eu-central-1.aws.gigantic.io
# clusterID is dynamic environment value, calculated after cluster creation
# applies only to Giant Swarm clusters
clusterID: uun5a
# provider is dynamic environment value, which comes from application catalog configuration
# applies only to Giant Swarm clusters
provider: kvm
# cluster.profile is a dynamic value, it comes from the cluster values configmap
# applies only to Giant Swarm clusters
cluster:
  profile: 4
# ingressController is dynamic environment value, which comes from application catalog configuration
# applies only to Giant Swarm clusters
ingressController:
  legacy: false

# for all the nginx configmap config options see https://github.com/kubernetes/ingress-nginx/blob/master/docs/user-guide/nginx-configuration/configmap.md#configmaps
configmap:
  error-log-level: "notice"
  # Disables setting a 'Strict-Transport-Security' header, which can be harmful.
  # See https://github.com/kubernetes/ingress-nginx/issues/549#issuecomment-291894246
  hsts: "false"
  max-worker-connections: "0"
  max-worker-open-files: "0"
  # Increase hash table size to allow more server names for stability reasons
  server-name-hash-bucket-size: "1024"
  server-tokens: "false"
  worker-processes: "1"
  # value of worker-shutdown-timeout should not be higher than configured `controller.terminationGracePeriodSeconds`
  worker-shutdown-timeout: "240s"
  use-forwarded-headers: "true"

controller:
  name: nginx-ingress-controller
  k8sAppLabel: nginx-ingress-controller

  replicaCount: 1

  maxUnavailable: 1
  # minReadySeconds to avoid killing pods before we are ready
  minReadySeconds: 0

  configmap:
    name: ingress-nginx

  image:
    repository: giantswarm/nginx-ingress-controller
    # when updating tag make sure to also keep appVersion in Chart.yaml in sync
    tag: 0.30.0

  rbac:

  role:
    name: nginx-ingress-role

  service:
    enabled: false
    # type applies only to AWS provider:
    # - external (default)
    # - internal
    # ...
    type: external
    # Sets the NodePorts that maps to the Ingress' ports 80 (http) and 443 (https).
    # nodePort service type is not created for AWS provider as LoadBalancer is used there.
    nodePorts:
      http: 30010
      https: 30011

  metrics:
    enabled: false
    port: 10254

    service:
      servicePort: 9913

  resources:
    # these are default resource requests when cluster profile is not known/determined or when cluster is larger than small
    requests:
      cpu: 2
      memory: 2.5Gi
  profile:
    # xxs (1) cluster profile - 1 worker node only - resource requests are not being set
    # xs (2) cluster profile - 2-3 worker nodes, max CPU < 4 - resource requests are not being set
    # TODO set resource requests same as small once coredns scale and resources are cluster profile adjusted https://github.com/giantswarm/giantswarm/issues/9316
    # small (3) cluster profile - > 3 worker nodes, max CPU still < 4
    small:
      resources:
        requests:
          cpu: 500m
          memory: 600Mi

  # allow the draining of connections up to five minutes
  # this should not be lower than configmap.worker-shutdown-timeout
  # for more info see https://github.com/kubernetes/ingress-nginx/pull/4487#issuecomment-525588554
  # and important note in https://github.com/kubernetes/ingress-nginx/releases/tag/nginx-0.26.0
  terminationGracePeriodSeconds: 300
  lifecycle:
    # Enable graceful shutdowns and rolling updates with zero-downtime
    preStop:
      exec:
        command:
        - /wait-shutdown

  # optional hpa settings
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 20
    targetCPUUtilizationPercentage: 50
    targetMemoryUtilizationPercentage: 80

  # command args options
  annotationsPrefix: nginx.ingress.kubernetes.io
  defaultSSLCertificate: ""
  ingressClass: nginx

  # www-data -> uid 101
  userID: 101
  groupID: 101

  sysctls:
    # Ingress controller performance improvements
    # See https://github.com/kubernetes/ingress-nginx/issues/1939
    - name: net.ipv4.ip_local_port_range
      value: "'1024 65000'" # default '32768	60999', we set it on host to '1024 65535'
    - name: net.core.somaxconn # this is unsafe, has to be allowed on kubelet with https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/kubelet/config/v1beta1/types.go#L757
      value: "32768" # default 128, we set it on host to '32768'

image:
  registry: quay.io

test:
  image:
    registry: quay.io
    repository: giantswarm/alpine-testing
    tag: 0.1.0
